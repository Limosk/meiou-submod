# Triggers and effects will be given the Actor's scope, with the Recipient's as FROM
negotiate_alliance = {
	category = alliance
	
	alert_index = 44
	alert_tooltip = ICON_SUBJUGATION
	
	require_acceptance = yes # Whether the recipient gets an option to decline
	
	is_visible = {
		FROM = { 
			isValidCountry = yes 
			is_free_or_tributary_trigger = yes
			NOT = { overlord_of = ROOT }
			NOT = { alliance_with = ROOT }
			NOT = { check_key = { lhs = Diplo_Poss_Ally value = 1 } }
		}
	}
	
	is_allowed = {
		is_at_war = no
		is_year = 1357
		custom_trigger_tooltip = {
			tooltip = ALLIANCE_LIMIT_NEGOTIATE
			check_key = { lhs = Diplo_Poss_Ally value = 1 }
		}
		FROM = { 
			is_at_war = no 
			custom_trigger_tooltip = {
				tooltip = FROM_ALLIANCE_LIMIT_NEGOTIATE
				NOT = { check_key = { lhs = Diplo_Poss_Ally value = 1 } }
			}
		}
		NOT = { is_rival = FROM }
		NOT = { FROM = { is_rival = ROOT } }
		#variable_arithmetic_trigger = {
		#	custom_tooltip = OUTSIDE_DIPLOMATIC_RANGE
		#	export_to_variable = {
		#		variable_name = border_distance
		#		value = border_distance
		#		who = FROM
		#		with = ROOT
		#	}
		#	check_variable = {
		#		which = oko
		#		which = border_distance
		#	}
		#}
		NOT = { is_subject = yes }
		NOT = { has_global_flag = mec_diplomacy_alliance_negotiations }
	}
	
	on_accept = {
		add_dip_power = -25
		#FROM = {
		#	if = { limit = { ai = yes }
		#		every_ally = { #use trust to break alliance, because pdx wtf no break_alliance effect
		#			set_key = { lhs = Diplo_Tmp0 which = Diplo_Mil_Strength }
		#
		#			if = { limit = { check_key = { lhs = Diplo_Tmp0 which = FROM } }
		#				FROM = { set_key = { lhs = Diplo_Tmp0 which = PREV } }
		#				save_event_target_as = cancel_alliance_target
		#			}
		#			set_key = { lhs = Diplo_Tmp0 value = 0 }
		#		}
		#		event_target:cancel_alliance_target = {
		#			#use opinion to break alliance, because pdx wtf no break_alliance effect -> takes a while to take effect
		#			add_opinion = {
		#				who = FROM
		#				modifier = alliance_broken
		#			}				
		#		}
		#	} else = {
		#		country_event = { id = mec_diplomacy.100 days = 1 }
		#	}
		#}
		## create new alliance
		#create_alliance = FROM
		country_event = { id = mec_diplomacy.101 days = 2 }
		save_global_event_target_as = alliance_negotiation_root
		FROM = { save_global_event_target_as = alliance_negotiation_target }
		set_global_flag = mec_diplomacy_alliance_negotiations
	}
	on_decline = {
		add_dip_power = -25	
	}
	
	ai_acceptance = {
		add_entry = {
			name = BASE_AI_ACCEPTANCE
			export_to_variable = { # Activate ai_value variable
				variable_name = ai_value
				value = opinion
				who = FROM
				with = ROOT
			}
			set_variable = { which = ai_value value = -25 }
		}
		add_entry = {
			name = OPINION
			export_to_variable = {
				variable_name = ai_value
				value = opinion
				who = FROM
				with = ROOT
			}
			divide_variable = { which = ai_value value = 4 }
		}
#		add_entry = {
#			name = AI_ATTITUDE
#			if = { limit = { FROM = { ai_attitude = { who = ROOT attitude = attitude_friendly }	} }
#				set_variable = { which = ai_value value = 50 }
#			} else_if = { limit = { FROM = { ai_attitude = { who = ROOT attitude = attitude_hostile } } }
#				set_variable = { which = ai_value value = -100 }
#			}
#		}
		add_entry = {
			name = MYDIPLOREP_TT
			export_to_variable = {
				variable_name = ai_value
				value = modifier:diplomatic_reputation
			}
			multiply_variable = { which = ai_value value = 3 }
		}
		add_entry = {
			name = BORDERDISTANCE_TT
			export_to_variable = {
				which = ai_value
				value = border_distance
				who = FROM
				with = ROOT
			}
			divide_variable = { which = ai_value value = -8 }
		}
	}
	
	ai_will_do = { # this is a trigger
		always = no
	}
}